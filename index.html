<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Vendas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map {
      height: 600px;
      width: 100%;
      margin-bottom: 20px;
    }

    .filtros {
      margin-bottom: 10px;
    }

    .resumo {
      margin-top: 20px;
      font-weight: bold;
    }

    .tabela-detalhes {
      margin-top: 10px;
      border-collapse: collapse;
      width: 100%;
    }

    .tabela-detalhes th, .tabela-detalhes td {
      border: 1px solid #ccc;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="filtros">
    <label for="filtroAno">Ano:</label>
    <select id="filtroAno"></select>

    <label for="filtroMes">Mês:</label>
    <select id="filtroMes"></select>
  </div>

  <div id="map"></div>

  <div class="resumo" id="resumoEstado"></div>
  <div id="detalhesCidade"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // Simulação de dados
    const dados = [
      { estado: "RS", cidade: "Porto Alegre", latitude: -30.0346, longitude: -51.2177, quantidade: 10, mes: "Janeiro", ano: 2024 },
      { estado: "RS", cidade: "Caxias do Sul", latitude: -29.1676, longitude: -51.1794, quantidade: 5, mes: "Janeiro", ano: 2024 },
      { estado: "RS", cidade: "Porto Alegre", latitude: -30.0346, longitude: -51.2177, quantidade: 8, mes: "Fevereiro", ano: 2024 },
      { estado: "SP", cidade: "São Paulo", latitude: -23.5505, longitude: -46.6333, quantidade: 20, mes: "Janeiro", ano: 2024 },
      { estado: "SP", cidade: "Campinas", latitude: -22.9099, longitude: -47.0626, quantidade: 12, mes: "Janeiro", ano: 2024 },
      { estado: "SP", cidade: "Campinas", latitude: -22.9099, longitude: -47.0626, quantidade: 5, mes: "Fevereiro", ano: 2024 }
    ];

    const mapa = L.map('map').setView([-23.5505, -46.6333], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(mapa);

    let marcadores = [];

    function agruparPorEstadoECidade(dadosFiltrados) {
      const agrupado = {};

      dadosFiltrados.forEach(item => {
        const chave = item.estado + "-" + item.cidade;
        if (!agrupado[chave]) {
          agrupado[chave] = {
            estado: item.estado,
            cidade: item.cidade,
            latitude: item.latitude,
            longitude: item.longitude,
            total: 0,
            detalhes: []
          };
        }
        agrupado[chave].total += item.quantidade;
        agrupado[chave].detalhes.push(item);
      });

      return Object.values(agrupado);
    }

    function atualizarMapa() {
      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      const anoSelecionado = document.getElementById("filtroAno").value;
      const mesSelecionado = document.getElementById("filtroMes").value;

      const dadosFiltrados = dados.filter(d => 
        (anoSelecionado === "" || d.ano == anoSelecionado) &&
        (mesSelecionado === "" || d.mes == mesSelecionado)
      );

      const agrupados = agruparPorEstadoECidade(dadosFiltrados);

      agrupados.forEach(item => {
        const marker = L.circleMarker([item.latitude, item.longitude], {
          radius: 5 + item.total,
          color: "blue",
          fillColor: "lightblue",
          fillOpacity: 0.6
        }).addTo(mapa);

        const nomeCidade = item.cidade;
        const totalQnt = item.total;

        marker.bindPopup(`<strong>${nomeCidade}</strong><br>Total QNT: ${totalQnt}`);
        marker.on("click", () => {
          mostrarResumoEstado(item.estado, dadosFiltrados);
          mostrarTabela(item.detalhes);
        });

        marcadores.push(marker);
      });
    }

    function mostrarResumoEstado(estado, dadosFiltrados) {
      const totalEstado = dadosFiltrados
        .filter(d => d.estado === estado)
        .reduce((soma, d) => soma + d.quantidade, 0);
      
      document.getElementById("resumoEstado").textContent = `Total de máquinas no estado ${estado}: ${totalEstado}`;
    }

    function mostrarTabela(detalhes) {
      let html = "<table class='tabela-detalhes'>";
      html += "<tr><th>Cidade</th><th>Quantidade</th><th>Mês</th><th>Ano</th></tr>";
      detalhes.forEach(d => {
        html += `<tr><td>${d.cidade}</td><td>${d.quantidade}</td><td>${d.mes}</td><td>${d.ano}</td></tr>`;
      });
      html += "</table>";

      document.getElementById("detalhesCidade").innerHTML = html;
    }

    function popularFiltros() {
      const anos = [...new Set(dados.map(d => d.ano))].sort();
      const meses = [...new Set(dados.map(d => d.mes))];

      const selAno = document.getElementById("filtroAno");
      const selMes = document.getElementById("filtroMes");

      selAno.innerHTML = "<option value=''>Todos</option>";
      selMes.innerHTML = "<option value=''>Todos</option>";

      anos.forEach(a => {
        selAno.innerHTML += `<option value='${a}'>${a}</option>`;
      });

      meses.forEach(m => {
        selMes.innerHTML += `<option value='${m}'>${m}</option>`;
      });

      selAno.addEventListener("change", atualizarMapa);
      selMes.addEventListener("change", atualizarMapa);
    }

    // Inicialização
    popularFiltros();
    atualizarMapa();
  </script>
</body>
</html>
