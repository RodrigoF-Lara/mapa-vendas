<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mapa de Vendas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
        .filtros {
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="filtros">
        Ano: <select id="filtroAno"></select>
        Mês: <select id="filtroMes">
            <option value="todos">Todos</option>
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const map = L.map('map').setView([-15.77972, -47.92972], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let dadosCSV = [];
        let geojsonLayer;

        const filtroAno = document.getElementById("filtroAno");
        const filtroMes = document.getElementById("filtroMes");

        Promise.all([
            fetch('geojs-100-mun.json').then(res => res.json()),
            fetch('vendas.csv').then(res => res.text())
        ]).then(([geojsonData, csvData]) => {
            dadosCSV = Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true
            }).data;

            // Preencher filtro de anos únicos
            const anosUnicos = [...new Set(dadosCSV.map(item => item.ANO))].sort();
            anosUnicos.forEach(ano => {
                const option = document.createElement("option");
                option.value = ano;
                option.textContent = ano;
                filtroAno.appendChild(option);
            });

            filtroAno.value = anosUnicos[0];

            function atualizarMapa() {
                const filtroAnoSelecionado = filtroAno.value;
                const filtroMesSelecionado = filtroMes.value;

                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }

                geojsonLayer = L.geoJSON(geojsonData, {
                    onEachFeature: function (feature, layer) {
                        const codigoIBGE = String(feature.properties.CD_MUN).trim();

                        const vendasCidade = dadosCSV.filter(item =>
                            String(item['TB_CIDADES.CODIGO_IBGE']).trim() === codigoIBGE &&
                            item.ANO === filtroAnoSelecionado &&
                            (filtroMesSelecionado === 'todos' || item.MÊS === filtroMesSelecionado)
                        );

                        if (vendasCidade.length > 0) {
                            const totalQnt = vendasCidade.reduce((sum, item) => sum + Number(item.QNT), 0);
                            const totalKg = vendasCidade.reduce((sum, item) => sum + Number(item.KG), 0);
                            const totalValor = vendasCidade.reduce((sum, item) => sum + Number(item.VALOR), 0);

                            const popupContent = `
                                <strong>${feature.properties.NM_MUN}</strong><br>
                                Quantidade: ${totalQnt}<br>
                                KG: ${totalKg.toLocaleString()}<br>
                                Valor: R$ ${totalValor.toLocaleString()}
                            `;

                            layer.bindPopup(popupContent);

                            // marcador no centro
                            const bounds = layer.getBounds();
                            if (bounds.isValid()) {
                                const center = bounds.getCenter();
                                L.circleMarker(center, {
                                    radius: 5,
                                    fillColor: "red",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                }).addTo(map);
                            }
                        }
                    }
                }).addTo(map);
            }

            filtroAno.addEventListener("change", atualizarMapa);
            filtroMes.addEventListener("change", atualizarMapa);

            atualizarMapa();
        });
    </script>
</body>
</html>
